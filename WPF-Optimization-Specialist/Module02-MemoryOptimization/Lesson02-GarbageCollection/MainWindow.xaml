<Window x:Class="GarbageCollection.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Garbage Collection Optimization" Height="750" Width="1100"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <Style TargetType="Button">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>
        <Style TargetType="TextBlock">
            <Setter Property="Margin" Value="5"/>
        </Style>
        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="10"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="200"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#1E88E5" Padding="15">
            <StackPanel>
                <TextBlock Text="Garbage Collection Optimization"
                          FontSize="24" FontWeight="Bold" Foreground="White"/>
                <TextBlock Text="Interactive demonstrations of .NET Garbage Collector behavior and optimization techniques"
                          FontSize="14" Foreground="#E3F2FD" Margin="0,5,0,0"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="1" Margin="10">
            <!-- GC Generations -->
            <TabItem Header="Generations">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Garbage Collector Generations" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            The .NET GC uses three generations to optimize collection. Short-lived objects stay
                            in Gen0, medium-lived in Gen1, and long-lived objects promote to Gen2.
                        </TextBlock>

                        <GroupBox Header="Generation Allocation Patterns">
                            <StackPanel>
                                <WrapPanel>
                                    <Button Content="Allocate Gen0 Objects" Click="AllocateGen0_Click"/>
                                    <Button Content="Promote to Gen1" Click="PromoteToGen1_Click"/>
                                    <Button Content="Promote to Gen2" Click="PromoteToGen2_Click"/>
                                    <Button Content="Clear All" Click="ClearAllocations_Click"/>
                                </WrapPanel>

                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Background="#C8E6C9" Padding="10" Margin="5" BorderBrush="#4CAF50" BorderThickness="2">
                                        <StackPanel>
                                            <TextBlock Text="Generation 0" FontWeight="Bold" FontSize="16" Foreground="#2E7D32"/>
                                            <TextBlock x:Name="Gen0ObjectCount" Text="Objects: 0" Margin="0,5,0,0"/>
                                            <TextBlock x:Name="Gen0Size" Text="Size: 0 KB"/>
                                            <TextBlock x:Name="Gen0Collections" Text="Collections: 0"/>
                                        </StackPanel>
                                    </Border>

                                    <Border Grid.Column="1" Background="#FFF9C4" Padding="10" Margin="5" BorderBrush="#FBC02D" BorderThickness="2">
                                        <StackPanel>
                                            <TextBlock Text="Generation 1" FontWeight="Bold" FontSize="16" Foreground="#F57F17"/>
                                            <TextBlock x:Name="Gen1ObjectCount" Text="Objects: 0" Margin="0,5,0,0"/>
                                            <TextBlock x:Name="Gen1Size" Text="Size: 0 KB"/>
                                            <TextBlock x:Name="Gen1Collections" Text="Collections: 0"/>
                                        </StackPanel>
                                    </Border>

                                    <Border Grid.Column="2" Background="#FFCCBC" Padding="10" Margin="5" BorderBrush="#E64A19" BorderThickness="2">
                                        <StackPanel>
                                            <TextBlock Text="Generation 2" FontWeight="Bold" FontSize="16" Foreground="#BF360C"/>
                                            <TextBlock x:Name="Gen2ObjectCount" Text="Objects: 0" Margin="0,5,0,0"/>
                                            <TextBlock x:Name="Gen2Size" Text="Size: 0 KB"/>
                                            <TextBlock x:Name="Gen2Collections" Text="Collections: 0"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>

                                <Border Background="#E1F5FE" Padding="10" Margin="0,10,0,0" BorderBrush="#0277BD" BorderThickness="1">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run FontWeight="Bold">Gen0:</Run> Collected frequently, most efficient
                                        <LineBreak/>
                                        <Run FontWeight="Bold">Gen1:</Run> Buffer between Gen0 and Gen2
                                        <LineBreak/>
                                        <Run FontWeight="Bold">Gen2:</Run> Collected rarely, most expensive
                                    </TextBlock>
                                </Border>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- GC Modes -->
            <TabItem Header="GC Modes">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Garbage Collection Modes" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            .NET supports different GC modes optimized for different scenarios:
                            Workstation (low-latency), Server (high-throughput), and concurrent options.
                        </TextBlock>

                        <GroupBox Header="Current GC Configuration">
                            <StackPanel>
                                <TextBlock x:Name="GCModeInfo" TextWrapping="Wrap" FontWeight="Bold"/>
                                <TextBlock x:Name="GCLatencyMode" Margin="0,5,0,0"/>
                                <TextBlock x:Name="GCConcurrentMode"/>

                                <Border Background="#FFF3E0" Padding="10" Margin="0,10,0,0" BorderBrush="#FF6F00" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock TextWrapping="Wrap" FontWeight="Bold" Margin="0,0,0,5">
                                            Latency Mode Options:
                                        </TextBlock>
                                        <TextBlock TextWrapping="Wrap">
                                            <Run FontWeight="Bold">Interactive:</Run> Default for UI apps
                                            <LineBreak/>
                                            <Run FontWeight="Bold">Batch:</Run> Disables concurrent GC for throughput
                                            <LineBreak/>
                                            <Run FontWeight="Bold">LowLatency:</Run> Minimize pauses (use carefully!)
                                            <LineBreak/>
                                            <Run FontWeight="Bold">SustainedLowLatency:</Run> For latency-sensitive scenarios
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <WrapPanel Margin="0,10,0,0">
                                    <Button Content="Set Interactive" Click="SetInteractiveMode_Click"/>
                                    <Button Content="Set LowLatency" Click="SetLowLatencyMode_Click"/>
                                    <Button Content="Set Batch" Click="SetBatchMode_Click"/>
                                    <Button Content="Refresh Info" Click="RefreshGCInfo_Click"/>
                                </WrapPanel>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Collection Triggers -->
            <TabItem Header="Collection Triggers">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Garbage Collection Triggers" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            Understand when and how GC collections are triggered, and best practices
                            for manual collection.
                        </TextBlock>

                        <GroupBox Header="Trigger Collection">
                            <StackPanel>
                                <TextBlock Text="Manual Collection:" FontWeight="Bold"/>
                                <WrapPanel>
                                    <Button Content="Collect Gen0" Click="CollectGen0_Click"/>
                                    <Button Content="Collect Gen1" Click="CollectGen1_Click"/>
                                    <Button Content="Collect Gen2" Click="CollectGen2_Click"/>
                                    <Button Content="Full Collect + Compact" Click="FullCollect_Click"/>
                                </WrapPanel>

                                <TextBlock Text="Before Collection:" FontWeight="Bold" Margin="0,10,0,0"/>
                                <TextBlock x:Name="BeforeCollectionMemory" Text="Memory: -- MB"/>

                                <TextBlock Text="After Collection:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock x:Name="AfterCollectionMemory" Text="Memory: -- MB"/>
                                <TextBlock x:Name="CollectionStats" Text="Collections performed: --" TextWrapping="Wrap"/>

                                <Border Background="#FFEBEE" Padding="10" Margin="0,10,0,0" BorderBrush="#C62828" BorderThickness="1">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run FontWeight="Bold">Warning:</Run> Manual GC.Collect() should rarely be used in production.
                                        Only call it when you know you've released large amounts of memory and want to
                                        reclaim it immediately (e.g., after closing a large document).
                                    </TextBlock>
                                </Border>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Automatic Collection Demonstration">
                            <StackPanel>
                                <TextBlock Text="Allocate memory to trigger automatic collections:" FontWeight="Bold"/>
                                <WrapPanel>
                                    <Button Content="Allocate 100 MB" Click="AllocateLargeMemory_Click"/>
                                    <Button Content="Allocate Many Small" Click="AllocateManySmall_Click"/>
                                    <Button Content="Stop Allocation" Click="StopAllocation_Click"/>
                                </WrapPanel>

                                <TextBlock x:Name="AllocationStatus" Text="Status: Idle" Margin="0,10,0,0" FontWeight="Bold"/>
                                <TextBlock x:Name="AutoCollectionCount" Text="Auto-collections detected: 0"/>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Allocation Patterns -->
            <TabItem Header="Allocation Patterns">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Memory Allocation Patterns" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            Different allocation patterns have different impacts on GC performance.
                            Learn optimal patterns for WPF applications.
                        </TextBlock>

                        <GroupBox Header="Pattern Comparison">
                            <StackPanel>
                                <TextBlock Text="Compare different allocation strategies:" FontWeight="Bold"/>

                                <Border Background="#E8F5E9" Padding="10" Margin="0,10,0,0" BorderBrush="#4CAF50" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="Good Pattern: Object Pooling" FontWeight="Bold" Foreground="#2E7D32"/>
                                        <TextBlock TextWrapping="Wrap" Margin="0,5,0,0">
                                            Reuse objects instead of creating new ones. Reduces GC pressure.
                                        </TextBlock>
                                        <WrapPanel Margin="0,5,0,0">
                                            <Button Content="Use Object Pool" Click="UseObjectPool_Click"/>
                                            <TextBlock x:Name="PoolStats" Text="Pool: 0 objects" VerticalAlignment="Center"/>
                                        </WrapPanel>
                                    </StackPanel>
                                </Border>

                                <Border Background="#FFEBEE" Padding="10" Margin="0,10,0,0" BorderBrush="#F44336" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="Bad Pattern: Excessive Allocations" FontWeight="Bold" Foreground="#C62828"/>
                                        <TextBlock TextWrapping="Wrap" Margin="0,5,0,0">
                                            Creating many short-lived objects increases GC frequency.
                                        </TextBlock>
                                        <WrapPanel Margin="0,5,0,0">
                                            <Button Content="Excessive Allocations" Click="ExcessiveAllocations_Click"/>
                                            <TextBlock x:Name="ExcessiveStats" Text="Objects: 0" VerticalAlignment="Center"/>
                                        </WrapPanel>
                                    </StackPanel>
                                </Border>

                                <Border Background="#E1F5FE" Padding="10" Margin="0,10,0,0" BorderBrush="#0277BD" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="Optimal Pattern: ArrayPool" FontWeight="Bold" Foreground="#01579B"/>
                                        <TextBlock TextWrapping="Wrap" Margin="0,5,0,0">
                                            Use ArrayPool&lt;T&gt; for temporary arrays to avoid allocations.
                                        </TextBlock>
                                        <WrapPanel Margin="0,5,0,0">
                                            <Button Content="Use ArrayPool" Click="UseArrayPool_Click"/>
                                            <TextBlock x:Name="ArrayPoolStats" Text="Arrays: 0" VerticalAlignment="Center"/>
                                        </WrapPanel>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Finalization -->
            <TabItem Header="Finalization">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Finalization and Resurrection" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            Objects with finalizers require two GC cycles to be collected. Understanding
                            finalization is crucial for resource management.
                        </TextBlock>

                        <GroupBox Header="Finalizer Demonstration">
                            <StackPanel>
                                <WrapPanel>
                                    <Button Content="Create w/ Finalizer" Click="CreateWithFinalizer_Click"/>
                                    <Button Content="Create w/ Dispose" Click="CreateWithDispose_Click"/>
                                    <Button Content="Force Finalization" Click="ForceFinalization_Click"/>
                                </WrapPanel>

                                <TextBlock Text="Finalizer Queue:" FontWeight="Bold" Margin="0,10,0,0"/>
                                <TextBlock x:Name="FinalizerStats" Text="Pending finalizers: --" TextWrapping="Wrap"/>

                                <Border Background="#FFF3E0" Padding="10" Margin="0,10,0,0" BorderBrush="#FF6F00" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="Finalization Process:" FontWeight="Bold"/>
                                        <TextBlock TextWrapping="Wrap" Margin="0,5,0,0">
                                            1. Object becomes eligible for collection
                                            <LineBreak/>
                                            2. Moved to finalization queue (survives first GC)
                                            <LineBreak/>
                                            3. Finalizer runs on dedicated thread
                                            <LineBreak/>
                                            4. Object collected in next GC cycle
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <Border Background="#E8F5E9" Padding="10" Margin="0,10,0,0" BorderBrush="#4CAF50" BorderThickness="1">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run FontWeight="Bold">Best Practice:</Run> Implement IDisposable instead of finalizers
                                        when possible. Use finalizers only as a safety net for unmanaged resources.
                                    </TextBlock>
                                </Border>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Memory Pressure -->
            <TabItem Header="Memory Pressure">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Memory Pressure Management" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            When managing unmanaged resources, you can notify the GC about memory pressure
                            to trigger collections appropriately.
                        </TextBlock>

                        <GroupBox Header="Memory Pressure API">
                            <StackPanel>
                                <TextBlock TextWrapping="Wrap">
                                    Use GC.AddMemoryPressure() and GC.RemoveMemoryPressure() to inform
                                    the GC about unmanaged memory allocations.
                                </TextBlock>

                                <WrapPanel Margin="0,10,0,0">
                                    <Button Content="Add Pressure (10 MB)" Click="AddMemoryPressure_Click"/>
                                    <Button Content="Remove Pressure" Click="RemoveMemoryPressure_Click"/>
                                </WrapPanel>

                                <TextBlock Text="Current Pressure:" FontWeight="Bold" Margin="0,10,0,0"/>
                                <TextBlock x:Name="MemoryPressureAmount" Text="0 MB"/>
                                <TextBlock x:Name="PressureCollections" Text="Collections triggered: 0" Margin="0,5,0,0"/>

                                <Border Background="#E1F5FE" Padding="10" Margin="0,10,0,0" BorderBrush="#0277BD" BorderThickness="1">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run FontWeight="Bold">Use Case:</Run> When wrapping large unmanaged resources
                                        (native images, DirectX buffers, etc.), add memory pressure to help GC make
                                        informed collection decisions.
                                    </TextBlock>
                                </Border>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- GC Notifications -->
            <TabItem Header="GC Notifications">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="GC Notifications" FontSize="18" FontWeight="Bold"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,5">
                            Register for notifications about approaching and completed full GC collections.
                            Useful for server applications that want to redirect traffic before GC.
                        </TextBlock>

                        <GroupBox Header="Notification System">
                            <StackPanel>
                                <WrapPanel>
                                    <Button Content="Enable Notifications" Click="EnableGCNotifications_Click"/>
                                    <Button Content="Disable Notifications" Click="DisableGCNotifications_Click"/>
                                    <Button Content="Clear Log" Click="ClearNotificationLog_Click"/>
                                </WrapPanel>

                                <TextBlock Text="Notification Log:" FontWeight="Bold" Margin="0,10,0,0"/>
                                <Border Background="#F5F5F5" BorderBrush="#9E9E9E" BorderThickness="1" Height="150" Margin="0,5,0,0">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <TextBlock x:Name="NotificationLog" Text="No notifications yet..." Margin="5" TextWrapping="Wrap"/>
                                    </ScrollViewer>
                                </Border>

                                <Border Background="#FFF3E0" Padding="10" Margin="0,10,0,0" BorderBrush="#FF6F00" BorderThickness="1">
                                    <TextBlock TextWrapping="Wrap">
                                        <Run FontWeight="Bold">Note:</Run> GC notifications are primarily for server scenarios
                                        where you want to prepare for or respond to full blocking collections.
                                    </TextBlock>
                                </Border>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Live Statistics Panel -->
        <Border Grid.Row="2" Background="#263238" Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Live GC Statistics" FontSize="16" FontWeight="Bold" Foreground="White" Margin="0,0,0,10"/>

                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Memory Stats -->
                    <Border Grid.Column="0" Background="#37474F" Padding="10" Margin="5" CornerRadius="5">
                        <StackPanel>
                            <TextBlock Text="Memory Usage" FontWeight="Bold" Foreground="#B0BEC5" FontSize="12"/>
                            <TextBlock x:Name="TotalMemory" Text="Total: 0 MB" Foreground="White" FontSize="14" Margin="0,5,0,0"/>
                            <TextBlock x:Name="HeapSize" Text="Heap: 0 MB" Foreground="#90CAF9" Margin="0,2,0,0"/>
                            <TextBlock x:Name="FragmentedBytes" Text="Fragmented: 0 MB" Foreground="#FFA726" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Collection Stats -->
                    <Border Grid.Column="1" Background="#37474F" Padding="10" Margin="5" CornerRadius="5">
                        <StackPanel>
                            <TextBlock Text="Collections" FontWeight="Bold" Foreground="#B0BEC5" FontSize="12"/>
                            <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                <TextBlock Text="Gen0: " Foreground="White"/>
                                <TextBlock x:Name="LiveGen0Count" Text="0" Foreground="#66BB6A" FontWeight="Bold"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                <TextBlock Text="Gen1: " Foreground="White"/>
                                <TextBlock x:Name="LiveGen1Count" Text="0" Foreground="#FFA726" FontWeight="Bold"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                <TextBlock Text="Gen2: " Foreground="White"/>
                                <TextBlock x:Name="LiveGen2Count" Text="0" Foreground="#EF5350" FontWeight="Bold"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Performance Stats -->
                    <Border Grid.Column="2" Background="#37474F" Padding="10" Margin="5" CornerRadius="5">
                        <StackPanel>
                            <TextBlock Text="Performance" FontWeight="Bold" Foreground="#B0BEC5" FontSize="12"/>
                            <TextBlock x:Name="GCTimePercent" Text="GC Time: 0%" Foreground="White" FontSize="14" Margin="0,5,0,0"/>
                            <TextBlock x:Name="PauseDuration" Text="Last Pause: -- ms" Foreground="#90CAF9" Margin="0,2,0,0"/>
                            <TextBlock x:Name="AllocationRate" Text="Allocation: 0 MB/s" Foreground="#FFA726" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Controls -->
                    <StackPanel Grid.Column="3" VerticalAlignment="Center" Margin="10,0">
                        <Button Content="Refresh Stats" Click="RefreshStats_Click" Background="#43A047" Foreground="White"/>
                        <Button Content="Reset Counters" Click="ResetCounters_Click" Background="#E53935" Foreground="White" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>
